<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è‚¡è²¡å ±ç›£æ¸¬ç«™</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-top: 50px; }
        .main-card { max-width: 600px; margin: auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .data-box { background: #f1f3f5; border-radius: 10px; padding: 15px; margin-top: 20px; display: none; }
        .error-box { color: red; font-size: 14px; margin-top: 10px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="main-card">
        <h3 class="text-center fw-bold mb-4">ğŸ“ˆ è²¡å‹™æŒ‡æ¨™æŸ¥è©¢</h3>
        <div class="input-group mb-2">
            <input type="text" id="stockId" class="form-control" placeholder="è¼¸å…¥å°è‚¡ä»£è™Ÿ (å¦‚: 2330)">
            <button class="btn btn-primary" onclick="checkStock()">æŸ¥è©¢æ•¸æ“š</button>
        </div>
        <p class="text-muted small text-center">æ”¯æ´å°è‚¡æœ¬ç›Šæ¯”èˆ‡æ¯›åˆ©ç‡æŸ¥è©¢</p>
        
        <div id="loader" class="text-center my-3" style="display:none;">
            <div class="spinner-border spinner-border-sm text-primary"></div> æ•¸æ“šè®€å–ä¸­...
        </div>

        <div id="errorBox" class="error-box text-center"></div>

        <div id="resultBox" class="data-box">
            <div class="d-flex justify-content-between mb-2">
                <span>è‚¡ç¥¨åç¨±ï¼š</span><strong id="resName">--</strong>
            </div>
            <hr>
            <div class="d-flex justify-content-between mb-2">
                <span>æœ¬ç›Šæ¯” (PE)ï¼š</span><strong id="resPE" class="text-primary">--</strong>
            </div>
            <div class="d-flex justify-content-between">
                <span>æ¯›åˆ©ç‡ (GM)ï¼š</span><strong id="resGM" class="text-success">--</strong>
            </div>
        </div>
    </div>
</div>

<script>
    async function checkStock() {
        const stockId = document.getElementById('stockId').value.trim();
        const loader = document.getElementById('loader');
        const resultBox = document.getElementById('resultBox');
        const errorBox = document.getElementById('errorBox');

        if (!stockId) return alert("è«‹è¼¸å…¥ä»£è™Ÿ");

        // åˆå§‹åŒ–ç‹€æ…‹
        loader.style.display = 'block';
        resultBox.style.display = 'none';
        errorBox.style.display = 'none';

        try {
            // æŠ“å–æœ¬ç›Šæ¯”æ•¸æ“š (FinMind API - ä¸éœ€è¦ Key ä¹Ÿèƒ½å°é‡æ¸¬è©¦)
            const peUrl = `https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPBR&data_id=${stockId}`;
            const peRes = await fetch(peUrl);
            const peJson = await peRes.json();

            // æŠ“å–ç¶œåˆæç›Šè¡¨ (å–å¾—æ¯›åˆ©ç‡)
            const gmUrl = `https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockFinancialStatements&data_id=${stockId}`;
            const gmRes = await fetch(gmUrl);
            const gmJson = await gmRes.json();

            if (peJson.data && peJson.data.length > 0) {
                const latestPE = peJson.data[peJson.data.length - 1];
                document.getElementById('resName').innerText = stockId;
                document.getElementById('resPE').innerText = latestPE.PE + " å€";
                
                // è¨ˆç®—æ¯›åˆ©ç‡ (ç‡Ÿæ¥­æ¯›åˆ© / ç‡Ÿæ¥­æ”¶å…¥)
                const financialData = gmJson.data;
                const revenue = financialData.find(d => d.type === 'Revenue')?.value || 0;
                const grossProfit = financialData.find(d => d.type === 'GrossProfit')?.value || 0;
                
                if (revenue !== 0) {
                    const gmPercentage = ((grossProfit / revenue) * 100).toFixed(2);
                    document.getElementById('resGM').innerText = gmPercentage + " %";
                } else {
                    document.getElementById('resGM').innerText = "æš«ç„¡æ•¸æ“š";
                }

                loader.style.display = 'none';
                resultBox.style.display = 'block';
            } else {
                throw new Error("æ‰¾ä¸åˆ°è©²è‚¡ç¥¨è³‡æ–™ï¼Œè«‹ç¢ºèªä»£è™Ÿæ˜¯å¦æ­£ç¢ºã€‚");
            }

        } catch (err) {
            loader.style.display = 'none';
            errorBox.innerText = "ğŸš¨ éŒ¯èª¤: " + err.message;
            errorBox.style.display = 'block';
            console.error(err);
        }
    }
</script>

</body>
</html>
