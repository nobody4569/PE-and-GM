<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Data Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; padding-top: 50px; }
        .card { border-radius: 15px; border: none; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .data-val { font-weight: bold; color: #0d6efd; }
        #errorMessage { color: #dc3545; display: none; margin-top: 15px; font-size: 14px; }
    </style>
</head>
<body>

<div class="container" style="max-width: 500px;">
    <div class="card p-4">
        <h4 class="text-center mb-4">台股即時指標查詢</h4>
        
        <div class="input-group mb-3">
            <input type="text" id="stockCode" class="form-control" placeholder="輸入台股代號 (如 2330)">
            <button class="btn btn-primary" onclick="queryData()">查詢</button>
        </div>

        <div id="loading" class="text-center my-3" style="display:none;">
            <div class="spinner-border spinner-border-sm text-primary"></div> 讀取中...
        </div>

        <div id="result" style="display:none;">
            <hr>
            <div class="d-flex justify-content-between my-2">
                <span>代碼:</span> <span id="outId" class="data-val"></span>
            </div>
            <div class="d-flex justify-content-between my-2">
                <span>本益比 (PE):</span> <span id="outPE" class="data-val"></span>
            </div>
            <div class="d-flex justify-content-between my-2">
                <span>毛利率 (GM):</span> <span id="outGM" class="data-val"></span>
            </div>
        </div>

        <div id="errorMessage" class="text-center p-2 bg-light rounded"></div>
    </div>
</div>

<script>
    async function queryData() {
        const id = document.getElementById('stockCode').value.trim();
        const load = document.getElementById('loading');
        const res = document.getElementById('result');
        const err = document.getElementById('errorMessage');

        if (!id) return;

        // 重置介面
        load.style.display = 'block';
        res.style.display = 'none';
        err.style.display = 'none';

        try {
            // 使用 FinMind API，這是目前對 GitHub Pages 最友善的開放來源
            // 先抓取本益比與基本面
            const peApi = `https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPBR&data_id=${id}`;
            const fmApi = `https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockFinancialStatements&data_id=${id}`;

            const [peRes, fmRes] = await Promise.all([
                fetch(peApi).then(r => r.json()),
                fetch(fmApi).then(r => r.json())
            ]);

            if (!peRes.data || peRes.data.length === 0) {
                throw new Error("找不到該股票代號，請檢查是否輸入正確。");
            }

            // 取得最新一筆本益比
            const latestPE = peRes.data[peRes.data.length - 1].PE;
            
            // 計算毛利率 (找出最近一季的營業收入與營業成本)
            const fmData = fmRes.data;
            const rev = fmData.filter(d => d.type === 'Revenue').pop()?.value || 0;
            const cost = fmData.filter(d => d.type === 'CostOfGoodsSold').pop()?.value || 0;
            
            let gm = "暫無數據";
            if (rev > 0) {
                gm = (((rev - cost) / rev) * 100).toFixed(2) + "%";
            }

            // 顯示結果
            document.getElementById('outId').innerText = id;
            document.getElementById('outPE').innerText = latestPE + " 倍";
            document.getElementById('outGM').innerText = gm;

            load.style.display = 'none';
            res.style.display = 'block';

        } catch (error) {
            load.style.display = 'none';
            err.style.display = 'block';
            err.innerText = "讀取失敗: " + error.message;
            console.error(error);
        }
    }
</script>

</body>
</html>
