<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç¾è‚¡å³æ™‚æ•¸æ“šç›£æ§</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; padding-top: 30px; }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .table-container { background: white; border-radius: 15px; padding: 20px; margin-top: 20px; }
        #loader { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="text-center mb-4">
        <h2 class="fw-bold">ğŸ“Š å°ç¾è‚¡è²¡å ±ç›£æ¸¬å„€</h2>
        <p class="text-muted">æ”¯æ´ç¾è‚¡ (AAPL) èˆ‡ å°è‚¡ (2330)</p>
    </div>

    <div class="card p-4 mb-4">
        <div class="input-group">
            <input type="text" id="stockInput" class="form-control" placeholder="è¼¸å…¥ä»£ç¢¼ï¼Œä¾‹å¦‚: 2330, TSLA">
            <button class="btn btn-primary" onclick="startQuery()">æŸ¥è©¢</button>
        </div>
        <div id="loader" class="text-primary mt-2 small">æ­£åœ¨é€£ç·šè‡³ API ç²å–æœ€æ–°æ•¸æ“š...</div>
    </div>

    <div class="table-container shadow-sm">
        <table class="table table-hover">
            <thead class="table-dark">
                <tr>
                    <th>ä»£ç¢¼</th>
                    <th>åç¨±</th>
                    <th>è‚¡åƒ¹</th>
                    <th>æœ¬ç›Šæ¯” (PE)</th>
                    <th>æ¯›åˆ©ç‡ (GM)</th>
                </tr>
            </thead>
            <tbody id="resultBody">
                </tbody>
        </table>
    </div>
</div>

<script>
    // ä½ çš„å°ˆå±¬ API Key
    const API_KEY = 'qdDcU9HKLVfXbxgTCExTENKlkzlCJNU3';

    async function startQuery() {
        const input = document.getElementById('stockInput').value;
        const loader = document.getElementById('loader');
        const tableBody = document.getElementById('resultBody');
        
        if (!input.trim()) return alert("è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼");

        const symbols = input.split(',').map(s => {
            let sym = s.trim().toUpperCase();
            // è‡ªå‹•ä¿®æ­£å°è‚¡ä»£ç¢¼ï¼šè‹¥åªæœ‰æ•¸å­—å‰‡è£œ .TW
            return /^\d+$/.test(sym) ? sym + ".TW" : sym;
        });

        loader.style.display = 'block';

        for (let symbol of symbols) {
            try {
                // ä½¿ç”¨ Promise.allSettled ç¢ºä¿å³ä½¿ä¸€å€‹å¤±æ•—ï¼Œå…¶ä»–ä¹Ÿèƒ½è·‘
                const [quoteRes, ratioRes] = await Promise.all([
                    fetch(`https://financialmodelingprep.com/api/v3/quote/${symbol}?apikey=${API_KEY}`),
                    fetch(`https://financialmodelingprep.com/api/v3/ratios-ttm/${symbol}?apikey=${API_KEY}`)
                ]);

                const quoteData = await quoteRes.json();
                const ratioData = await ratioRes.json();

                if (quoteData && quoteData.length > 0) {
                    const s = quoteData[0];
                    const r = (ratioData && ratioData.length > 0) ? ratioData[0] : {};

                    // æ•¸å€¼è™•ç†é˜²å‘†
                    const pe = s.pe ? s.pe.toFixed(2) : "N/A";
                    const gm = r.grossProfitMarginTTM ? (r.grossProfitMarginTTM * 100).toFixed(2) + "%" : "N/A";

                    const row = `
                        <tr>
                            <td><strong>${s.symbol}</strong></td>
                            <td>${s.name || '---'}</td>
                            <td>${s.price} <small>${s.currency || ''}</small></td>
                            <td><span class="badge bg-info text-dark">${pe}</span></td>
                            <td><span class="badge bg-success">${gm}</span></td>
                        </tr>
                    `;
                    tableBody.insertAdjacentHTML('afterbegin', row);
                } else {
                    console.warn(`æ‰¾ä¸åˆ°ä»£ç¢¼ ${symbol} çš„è³‡æ–™`);
                }
            } catch (err) {
                console.error("æŸ¥è©¢å‡ºéŒ¯:", err);
            }
        }
        loader.style.display = 'none';
        document.getElementById('stockInput').value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
    }
</script>

</body>
</html>
